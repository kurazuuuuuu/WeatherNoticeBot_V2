name: è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Dockeræ¨©é™ã¨ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ã®ç¢ºèª
      run: |
        echo "ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: $(whoami)"
        echo "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—: $(groups)"
        
        # Dockerã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ç¢ºèª
        if ! systemctl is-active --quiet docker; then
          echo "Dockerã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹å§‹ä¸­..."
          sudo systemctl start docker
        fi
        
        # Dockeræ¥ç¶šãƒ†ã‚¹ãƒˆ
        if ! docker info > /dev/null 2>&1; then
          echo "Dockeræ¨©é™ã®å•é¡Œã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ä¿®æ­£ã‚’è©¦è¡Œã—ã¾ã™..."
          
          if ! groups | grep -q docker; then
            sudo usermod -aG docker $(whoami)
            echo "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’dockerã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã—ã¾ã—ãŸ"
          fi
          
          if [ ! -w /var/run/docker.sock ]; then
            sudo chmod 666 /var/run/docker.sock
            echo "Docker socketã®æ¨©é™ã‚’ä¿®æ­£ã—ã¾ã—ãŸ"
          fi
          
          if ! docker info > /dev/null 2>&1; then
            echo "âŒ Dockeræ¨©é™ã®å•é¡ŒãŒè§£æ±ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            echo "æ‰‹å‹•ã§ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„: ./scripts/fix-docker-permissions.sh"
            exit 1
          fi
        fi
        
        echo "âœ… Dockeræ¥ç¶šãŒæ­£å¸¸ã§ã™"
        docker --version
        docker compose version

    - name: ãƒ›ã‚¹ãƒˆå´ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ã‚’ä¿®æ­£
      # Docker Composeã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€
      # ãƒ›ã‚¹ãƒˆå´ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ‰€æœ‰è€…ã¨æ¨©é™ã‚’ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆã‚ã›ã¾ã™ã€‚
      run: |
        echo "ãƒ›ã‚¹ãƒˆå´ã®ãƒ­ã‚°/ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ã‚’ä¿®æ­£ä¸­..."
        # ã‚³ãƒ³ãƒ†ãƒŠå†…ã®botuserã®UID/GIDã¯1000:1000
        # ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã® `./logs` ã¨ `./data` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€æ‰€æœ‰è€…ã‚’å¤‰æ›´
        mkdir -p ./logs ./data # å­˜åœ¨ã—ãªã„å ´åˆã«ä½œæˆ
        sudo chown -R 1000:1000 ./logs ./data # botuserã®UID/GIDã«åˆã‚ã›ã¦å¤‰æ›´
        sudo chmod -R 775 ./logs ./data # ã‚ªãƒ¼ãƒŠãƒ¼ã¨ã‚°ãƒ«ãƒ¼ãƒ—ã«æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸
        echo "âœ… ãƒ›ã‚¹ãƒˆå´ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ãŒä¿®æ­£ã•ã‚Œã¾ã—ãŸ"

- name: ç’°å¢ƒå¤‰æ•°ã‚’ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰ç”Ÿæˆ
      run: |
        echo "ç’°å¢ƒå¤‰æ•°ã‚’ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰.envãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿ä¸­..."
        # æ—¢å­˜ã®.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
        > .env
        # å„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å€‹åˆ¥ã«.envãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€
        echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}" >> .env
        echo "DISCORD_GUILD_ID=${{ secrets.DISCORD_GUILD_ID }}" >> .env
        # echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
        echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
        # echo "COMMAND_PREFIX=${{ secrets.COMMAND_PREFIX }}" >> .env
        # echo "DEFAULT_TIMEZONE=${{ secrets.DEFAULT_TIMEZONE }}" >> .env
        # echo "NOTIFICATION_RETRY_ATTEMPTS=${{ secrets.NOTIFICATION_RETRY_ATTEMPTS }}" >> .env
        # echo "NOTIFICATION_RETRY_DELAY=${{ secrets.NOTIFICATION_RETRY_DELAY }}" >> .env
        # echo "JMA_API_RATE_LIMIT=${{ secrets.JMA_API_RATE_LIMIT }}" >> .env
        # echo "GEMINI_API_RATE_LIMIT=${{ secrets.GEMINI_API_RATE_LIMIT }}" >> .env
        # echo "LOG_LEVEL=${{ secrets.LOG_LEVEL }}" >> .env
        # echo "LOG_FILE=${{ secrets.LOG_FILE }}" >> .env
        # echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
        # echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
        # echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
        echo "âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"

    
    - name: æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
      run: |
        echo "æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ä¸­..."
        docker compose down || true
        
        docker system prune -f || true
    
    - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
      run: |
        echo "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        docker compose build --no-cache
    
    - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
      run: |
        echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ä¸­..."
        docker compose up -d
    
    - name: ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ã‚’ç¢ºèª
      run: |
        echo "ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
        sleep 10
        docker compose ps
        
        echo "ãƒ­ã‚°ã‚’ç¢ºèªä¸­..."
        docker compose logs --tail=20 weather-bot
    
    - name: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      run: |
        echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        max_attempts=30
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          if docker compose ps weather-bot | grep -q "healthy\|Up"; then
            echo "âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼"
            break
          else
            echo "â³ èµ·å‹•ã‚’å¾…æ©Ÿä¸­... ($attempt/$max_attempts)"
            sleep 10
            attempt=$((attempt + 1))
          fi
        done
        
        if [ $attempt -gt $max_attempts ]; then
          echo "âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
          docker compose logs weather-bot
          exit 1
        fi
    
    - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
      run: |
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
        echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
        echo "æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"
