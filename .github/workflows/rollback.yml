name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆã®ã‚³ãƒŸãƒƒãƒˆSHAï¼ˆçœç•¥æ™‚ã¯ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆï¼‰"
        required: false
        type: string

jobs:
  rollback:
    runs-on: self-hosted

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆã®ã‚³ãƒŸãƒƒãƒˆã‚’æ±ºå®š
        id: target
        run: |
          if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
            TARGET_SHA="${{ github.event.inputs.commit_sha }}"
          else
            # ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
            TARGET_SHA=$(git rev-parse HEAD~1)
          fi

          echo "target_sha=$TARGET_SHA" >> $GITHUB_OUTPUT
          echo "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆ: $TARGET_SHA"

          # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’è¡¨ç¤º
          git log --oneline -1 $TARGET_SHA

      - name: æŒ‡å®šã•ã‚ŒãŸã‚³ãƒŸãƒƒãƒˆã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        run: |
          echo "ã‚³ãƒŸãƒƒãƒˆ ${{ steps.target.outputs.target_sha }} ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸­..."
          git checkout ${{ steps.target.outputs.target_sha }}

      - name: æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
        run: |
          echo "æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ä¸­..."
          docker compose down || true

          # æœªä½¿ç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
          docker system prune -f || true

      - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
        run: |
          echo "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
          docker compose build --no-cache

      - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
        run: |
          echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ä¸­..."
          docker compose up -d

      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯çŠ¶æ³ã‚’ç¢ºèª
        run: |
          echo "ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
          sleep 10
          docker compose ps

          echo "ãƒ­ã‚°ã‚’ç¢ºèªä¸­..."
          docker compose logs --tail=20 weather-bot

      - name: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
          max_attempts=30
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            if docker compose ps | grep -q "healthy\|Up"; then
              echo "âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
              break
            else
              echo "â³ èµ·å‹•ã‚’å¾…æ©Ÿä¸­... ($attempt/$max_attempts)"
              sleep 10
              attempt=$((attempt + 1))
            fi
          done

          if [ $attempt -gt $max_attempts ]; then
            echo "âŒ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
            docker compose logs weather-bot
            exit 1
          fi

      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†é€šçŸ¥
        run: |
          echo "ğŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆã‚³ãƒŸãƒƒãƒˆ: ${{ steps.target.outputs.target_sha }}"
          echo "æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"
