name: è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Dockeræ¨©é™ã¨ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ã®ç¢ºèª
      run: |
        echo "ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: $(whoami)"
        echo "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—: $(groups)"
        
        # Dockerã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ç¢ºèª
        if ! systemctl is-active --quiet docker; then
          echo "Dockerã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹å§‹ä¸­..."
          sudo systemctl start docker
        fi
        
        # Dockeræ¥ç¶šãƒ†ã‚¹ãƒˆ
        if ! docker info > /dev/null 2>&1; then
          echo "Dockeræ¨©é™ã®å•é¡Œã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ä¿®æ­£ã‚’è©¦è¡Œã—ã¾ã™..."
          
          # dockerã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ï¼ˆæ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          if ! groups | grep -q docker; then
            sudo usermod -aG docker $(whoami)
            echo "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’dockerã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã—ã¾ã—ãŸ"
          fi
          
          # Docker socketã®æ¨©é™ç¢ºèª
          if [ ! -w /var/run/docker.sock ]; then
            sudo chmod 666 /var/run/docker.sock
            echo "Docker socketã®æ¨©é™ã‚’ä¿®æ­£ã—ã¾ã—ãŸ"
          fi
          
          # å†ãƒ†ã‚¹ãƒˆ
          if ! docker info > /dev/null 2>&1; then
            echo "âŒ Dockeræ¨©é™ã®å•é¡ŒãŒè§£æ±ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            echo "æ‰‹å‹•ã§ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„: ./scripts/fix-docker-permissions.sh"
            exit 1
          fi
        fi
        
        echo "âœ… Dockeræ¥ç¶šãŒæ­£å¸¸ã§ã™"
        docker --version
        docker compose version
    
    - name: æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
      run: |
        echo "æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ä¸­..."
        docker compose down || true
        
        # æœªä½¿ç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
        docker system prune -f || true
    
    - name: ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
      run: |
        if [ ! -f .env ]; then
          echo "âŒ ã‚¨ãƒ©ãƒ¼: .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "ğŸ“ .env.exampleã‚’å‚è€ƒã«.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„"
          echo ""
          echo "å¿…è¦ãªç’°å¢ƒå¤‰æ•°:"
          echo "- DISCORD_TOKEN (å¿…é ˆ)"
          echo "- GEMINI_API_KEY (æ¨å¥¨)"
          echo "- ãã®ä»–ã®è¨­å®šé …ç›®"
          echo ""
          echo "ä½œæˆæ–¹æ³•:"
          echo "cp .env.example .env"
          echo "# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦å®Ÿéš›ã®å€¤ã‚’è¨­å®š"
          exit 1
        else
          echo "âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          
          # å¿…é ˆç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
          missing_vars=()
          
          if ! grep -q "^DISCORD_TOKEN=" .env || grep -q "^DISCORD_TOKEN=$" .env || grep -q "^DISCORD_TOKEN=your_" .env; then
            missing_vars+=("DISCORD_TOKEN")
          fi
          
          if [ ${#missing_vars[@]} -gt 0 ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ä»¥ä¸‹ã®å¿…é ˆç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“:"
            for var in "${missing_vars[@]}"; do
              echo "  - $var"
            done
            echo ""
            echo ".envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ã€é©åˆ‡ãªå€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          echo "âœ… å¿…é ˆç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
        fi
    
    - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
      run: |
        echo "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        docker compose build --no-cache
    
    - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
      run: |
        echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ä¸­..."
        docker compose up -d
    
    - name: ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ã‚’ç¢ºèª
      run: |
        echo "ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
        sleep 10
        docker compose ps
        
        echo "ãƒ­ã‚°ã‚’ç¢ºèªä¸­..."
        docker compose logs --tail=20 weather-bot
    
    - name: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      run: |
        echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        max_attempts=30
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          if docker compose ps | grep -q "healthy\|Up"; then
            echo "âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼"
            break
          else
            echo "â³ èµ·å‹•ã‚’å¾…æ©Ÿä¸­... ($attempt/$max_attempts)"
            sleep 10
            attempt=$((attempt + 1))
          fi
        done
        
        if [ $attempt -gt $max_attempts ]; then
          echo "âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
          docker compose logs weather-bot
          exit 1
        fi
    
    - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
      run: |
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
        echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
        echo "æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"