# .github/workflows/deploy.yml

name: è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: 2. Dockerç’°å¢ƒã‚’ç¢ºèª
      run: |
        echo "ğŸ³ Dockerç’°å¢ƒã‚’ç¢ºèªã—ã¾ã™..."
        if ! docker info > /dev/null 2>&1; then
          echo "âš ï¸ Dockerã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ©ãƒ³ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          exit 1
        fi
        docker --version
        docker compose version

    - name: 3. ãƒœãƒªãƒ¥ãƒ¼ãƒ ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
      run: |
        mkdir -p ./logs ./data

    - name: 4. ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ« (.env) ã‚’ç”Ÿæˆ
      run: |
        echo "ğŸ”‘ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰ .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™..."
        # ç¢ºå®Ÿæ€§ã‚’å„ªå…ˆã—ã€ä¸€è¡Œãšã¤ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿ã¾ã™
        > .env # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆæœŸåŒ–
        echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}" >> .env
        echo "DISCORD_GUILD_ID=${{ secrets.DISCORD_GUILD_ID }}" >> .env
        echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
        echo "âœ… .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚"

    - name: 5. æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
      run: |
        echo "ğŸ§¹ æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤ã—ã¾ã™..."
        docker compose down --remove-orphans
    
    - name: 6. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
      run: |
        echo "ğŸ› ï¸ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™..."
        docker compose build
    
    - name: 7. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
      run: |
        echo "ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™..."
        docker compose run --rm weather-bot python -m alembic upgrade head
        echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ"

    - name: 8. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
      run: |
        echo "ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¾ã™..."
        docker compose up -d
    
    - name: 9. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚‹èµ·å‹•ç¢ºèª
      run: |
        echo "ğŸ©º èµ·å‹•çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™..."
        max_attempts=30
        interval=10
        
        for i in $(seq 1 $max_attempts); do
          # docker-compose.ymlå†…ã®ã‚µãƒ¼ãƒ“ã‚¹åã‚’æŒ‡å®š
          health_status=$(docker inspect --format '{{.State.Health.Status}}' weather-bot 2>/dev/null)
          
          if [ "$health_status" = "healthy" ]; then
            echo "âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼"
            docker compose ps
            break
          fi
          
          container_state=$(docker inspect --format '{{.State.Status}}' weather-bot 2>/dev/null)
          if [ "$container_state" != "running" ]; then
             echo "âŒ ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚"
             docker compose logs
             exit 1
          fi

          echo "â³ èµ·å‹•ã‚’å¾…æ©Ÿä¸­... (è©¦è¡Œ $i/$max_attempts)"
          sleep $interval
        done
        
        if [ "$health_status" != "healthy" ]; then
          echo "âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
          docker compose logs
          exit 1
        fi
    
    - name: 10. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
      run: |
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
