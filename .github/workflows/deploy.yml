name: è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 2. Dockerç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ç¢ºèª
      run: |
        echo "ğŸ³ Dockerç’°å¢ƒã‚’ç¢ºèªã—ã¾ã™..."
        # Dockerã‚µãƒ¼ãƒ“ã‚¹ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„å ´åˆã¯é–‹å§‹
        if ! systemctl is-active --quiet docker; then
          echo "Dockerã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹å§‹ã—ã¾ã™ã€‚"
          sudo systemctl start docker
        fi
        
        # Dockerã‚³ãƒãƒ³ãƒ‰ãŒsudoãªã—ã§å®Ÿè¡Œã§ãã‚‹ã‹ãƒ†ã‚¹ãƒˆ
        if ! docker info > /dev/null 2>&1; then
          echo "âš ï¸ Dockerã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ©ãƒ³ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          echo "æ¨å¥¨: ãƒ©ãƒ³ãƒŠãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ 'docker' ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã—ã€å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚"
          echo "å‚è€ƒã‚³ãƒãƒ³ãƒ‰: sudo usermod -aG docker $(whoami)"
          # /var/run/docker.sock ã®æ¨©é™å¤‰æ›´ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ãŸã‚éæ¨å¥¨
          exit 1
        fi
        
        echo "âœ… Dockerã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚"
        docker --version
        docker compose version

    - name: 3. ãƒ›ã‚¹ãƒˆå´ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™è¨­å®š
      run: |
        echo "ğŸ“¦ ãƒ›ã‚¹ãƒˆå´ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ã‚’è¨­å®šã—ã¾ã™..."
        # ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼(UID:1000, GID:1000)ãŒæ›¸ãè¾¼ã‚ã‚‹ã‚ˆã†ã«è¨­å®š
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        mkdir -p ./logs ./data
        sudo chown -R 1000:1000 ./logs ./data
        sudo chmod -R 775 ./logs ./data
        echo "âœ… ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚"

    - name: 4. ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ« (.env) ã®ç”Ÿæˆ
      run: |
        echo "ğŸ”‘ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰ .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™..."
        # heredocã‚’ä½¿ç”¨ã—ã¦ã€ã‚ˆã‚Šã‚¯ãƒªãƒ¼ãƒ³ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
        cat << EOF > .env
        DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
        DISCORD_GUILD_ID=${{ secrets.DISCORD_GUILD_ID }}
        GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
        # --- å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è§£é™¤ã—ã¦ãã ã•ã„ ---
        # DATABASE_URL=${{ secrets.DATABASE_URL }}
        # COMMAND_PREFIX=${{ secrets.COMMAND_PREFIX }}
        # DEFAULT_TIMEZONE=${{ secrets.DEFAULT_TIMEZONE }}
        # NOTIFICATION_RETRY_ATTEMPTS=${{ secrets.NOTIFICATION_RETRY_ATTEMPTS }}
        # NOTIFICATION_RETRY_DELAY=${{ secrets.NOTIFICATION_RETRY_DELAY }}
        # JMA_API_RATE_LIMIT=${{ secrets.JMA_API_RATE_LIMIT }}
        # GEMINI_API_RATE_LIMIT=${{ secrets.GEMINI_API_RATE_LIMIT }}
        # LOG_LEVEL=${{ secrets.LOG_LEVEL }}
        # LOG_FILE=${{ secrets.LOG_FILE }}
        # POSTGRES_DB=${{ secrets.POSTGRES_DB }}
        # POSTGRES_USER=${{ secrets.POSTGRES_USER }}
        # POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
        EOF
        echo "âœ… .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚"

    - name: 5. æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
      run: |
        echo "ğŸ§¹ æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤ã—ã¾ã™..."
        # --remove-orphans ã§ã€docker-compose.yml ã«å®šç¾©ã•ã‚Œãªããªã£ãŸã‚³ãƒ³ãƒ†ãƒŠã‚‚å‰Šé™¤
        docker compose down --remove-orphans
    
    - name: 6. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
      run: |
        echo "ğŸ› ï¸ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨)..."
        # --no-cache ã¯å‰Šé™¤ã—ã€Dockerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’æœ€å¤§é™ã«æ´»ç”¨
        # ã“ã‚Œã«ã‚ˆã‚Šã€å¤‰æ›´ãŒãªã„éƒ¨åˆ†ã®å†ãƒ“ãƒ«ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€æ™‚é–“ã‚’å¤§å¹…ã«çŸ­ç¸®
        docker compose build
    
    - name: 7. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
      run: |
        echo "ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•ã—ã¾ã™..."
        docker compose up -d
    
    - name: 8. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚‹èµ·å‹•ç¢ºèª (å†ä¿®æ­£ç‰ˆ)
      run: |
        echo "ğŸ©º ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•çŠ¶æ…‹ã‚’ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§ç¢ºèªã—ã¾ã™..."
        max_attempts=30
        interval=10 # ç§’
        
        for i in $(seq 1 $max_attempts); do
          # docker inspect ã‹ã‚‰ç›´æ¥ãƒ˜ãƒ«ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ã€‚ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ãªã„å ´åˆã‚‚è€ƒæ…®ã€‚
          health_status=$(docker inspect --format '{{.State.Health.Status}}' weather-bot 2>/dev/null)
          
          if [ "$health_status" = "healthy" ]; then
            echo "âœ… (è©¦è¡Œ $i/$max_attempts) ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼(Status: $health_status)"
            docker compose ps
            echo "--- ç›´è¿‘ã®ãƒ­ã‚° ---"
            docker compose logs --tail=50 weather-bot
            break
          fi
          
          # ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
          container_state=$(docker inspect --format '{{.State.Status}}' weather-bot 2>/dev/null)
          if [ "$container_state" != "running" ]; then
             # è¡¨ç¤ºç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ã‚’è¨­å®š (æ§‹æ–‡ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚)
             display_state=$container_state
             if [ -z "$container_state" ]; then
               display_state="not found"
             fi
             echo "âŒ (è©¦è¡Œ $i/$max_attempts) ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ (State: $display_state)ã€‚"
             docker compose logs weather-bot
             exit 1
          fi

          # è¡¨ç¤ºç”¨ã®ãƒ˜ãƒ«ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®š (æ§‹æ–‡ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚)
          display_status=$health_status
          if [ -z "$health_status" ]; then
            display_status="starting"
          fi

          # GitHub Actionsã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€${...} ã‚’ä½¿ã‚ãªã„å½¢ã§å‡ºåŠ›
          echo "â³ (è©¦è¡Œ $i/$max_attempts) èµ·å‹•ã‚’å¾…æ©Ÿä¸­... (Status: $display_status, Interval: ${interval}s)"
          sleep $interval
        done
        
        # ãƒ«ãƒ¼ãƒ—çµ‚äº†å¾Œã€æœ€çµ‚ç¢ºèª
        if [ "$health_status" != "healthy" ]; then
          echo "âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
          docker compose ps
          echo "--- æœ€çµ‚ãƒ­ã‚° ---"
          docker compose logs weather-bot
          exit 1
        fi
    
    - name: 9. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
      run: |
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
        echo "------------------------------------"
        echo "  Commit: ${{ github.sha }}"
        echo "  Branch: ${{ github.ref_name }}"
        echo "  Time:   $(date '+%Y-%m-%d %H:%M:%S')"
        echo "------------------------------------"
