name: è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
      run: |
        echo "æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ä¸­..."
        docker compose down || true
        
        # æœªä½¿ç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
        docker system prune -f || true
    
    - name: ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
      run: |
        if [ ! -f .env ]; then
          echo "è­¦å‘Š: .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚.env.exampleã‚’å‚è€ƒã«ä½œæˆã—ã¦ãã ã•ã„ã€‚"
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¶šè¡Œã—ã¾ã™ãŒã€ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        else
          echo ".envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚"
        fi
    
    - name: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
      run: |
        echo "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        docker compose build --no-cache
    
    - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
      run: |
        echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ä¸­..."
        docker compose up -d
    
    - name: ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ã‚’ç¢ºèª
      run: |
        echo "ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
        sleep 10
        docker compose ps
        
        echo "ãƒ­ã‚°ã‚’ç¢ºèªä¸­..."
        docker compose logs --tail=20 weather-bot
    
    - name: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      run: |
        echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        max_attempts=30
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          if docker compose ps | grep -q "healthy\|Up"; then
            echo "âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼"
            break
          else
            echo "â³ èµ·å‹•ã‚’å¾…æ©Ÿä¸­... ($attempt/$max_attempts)"
            sleep 10
            attempt=$((attempt + 1))
          fi
        done
        
        if [ $attempt -gt $max_attempts ]; then
          echo "âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
          docker compose logs weather-bot
          exit 1
        fi
    
    - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
      run: |
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
        echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
        echo "æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"